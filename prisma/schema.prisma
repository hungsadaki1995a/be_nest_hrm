// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthStatus {
  ACTIVE
  LOCKED
  DISABLED
}

model Auth {
  id          Int        @id @default(autoincrement())
  userId      Int        @unique
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  password    String
  status      AuthStatus @default(ACTIVE)
  lastLoginAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("auth")
}

enum UserStatus {
  WORKING
  RESIGN
  SUSPENDED
  PROBATION
}

model User {
  id          Int     @id @default(autoincrement())
  employeeId  String  @unique
  fullName    String
  email       String  @unique
  phoneNumber String  @unique
  avatarUrl   String?

  auth              Auth?
  status            UserStatus         @default(WORKING)
  roles             UserRole[]
  headOf            Department[]       @relation("DepartmentHead")
  leadOf            Team[]             @relation("TeamLeader")
  membersOf         TeamMember[]
  emergencyContacts EmergencyContact[]
  profile           UserProfile?
  profileHistory    UserProfileHistory[]
  employee          EmployeeInfo?
  employeeHistory   EmployeeInfoHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@map("users")
}

model EmergencyContact {
  id           Int     @id @default(autoincrement())
  userId       Int
  name         String
  phone        String
  relationship String
  isPrimary    Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("emergency_contacts")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  UNKNOWN
}

model UserProfile {
  userId               Int            @id
  englishName          String?
  gender               Gender?
  nationality          String?
  dateOfBirth          DateTime?
  identityId           String?
  identityIdIssueDate  DateTime?
  identityIdIssuePlace String?
  address              String?
  maritalStatus        MaritalStatus?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

model UserProfileHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  snapshot  Json
  changedBy Int?
  changedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_profile_history")
}

model EmployeeInfo {
  userId       Int       @id
  level        String
  onBoardAt    DateTime
  resignedAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("employee_info")
}

model EmployeeInfoHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  snapshot  Json
  changedBy Int?
  changedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("employee_info_history")
}

model Role {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  isActive    Boolean @default(true)

  users       UserRole[]
  permissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("roles")
}

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model Department {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  isActive    Boolean @default(true)

  headId Int
  head   User   @relation("DepartmentHead", fields: [headId], references: [id], onDelete: Restrict)
  teams  Team[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([headId])
  @@map("departments")
}

model Team {
  id          Int     @id @default(autoincrement())
  code        String  @unique
  name        String
  description String?
  isActive    Boolean @default(true)

  departmentId Int
  department   Department   @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  leaderId     Int?
  leader       User?        @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: SetNull)
  members      TeamMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([departmentId])
  @@index([leaderId])
  @@map("teams")
}

model TeamMember {
  teamId Int
  userId Int

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([teamId, userId])
  @@map("team_members")
}

enum Page {
  ROLE
  PERMISSION
  USER
  DASHBOARD
  DEPARTMENT
  TEAM
}

model RolePermission {
  roleId Int
  page   Page

  canCreate Boolean @default(false)
  canRead   Boolean @default(false)
  canUpdate Boolean @default(false)
  canDelete Boolean @default(false)

  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, page])
  @@map("role_permissions")
}

enum OtpPurpose {
  RESET_PASSWORD
}

model Otp {
  id        Int        @id @default(autoincrement())
  email     String
  otpHash   String
  isActive  Boolean    @default(false)
  attempts  Int        @default(0)
  purpose   OtpPurpose @default(RESET_PASSWORD)
  usedAt    DateTime?
  revokedAt DateTime?
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@map("otps")
}
